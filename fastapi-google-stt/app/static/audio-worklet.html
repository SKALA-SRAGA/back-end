<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AudioWorklet ê¸°ë°˜ STT</title>
    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      
      h2 {
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      
      button {
        padding: 8px 16px;
        margin-right: 10px;
        border: none;
        border-radius: 4px;
        background-color: #4285f4;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }
      
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      
      #result-container {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 10px;
        min-height: 100px;
        background-color: #f9f9f9;
        border-radius: 4px;
        line-height: 1.5;
      }
      
      #transcription {
        display: inline;
      }
      
      .interim-text {
        color: #888;
        display: inline;
      }
      
      pre {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        background-color: #f9f9f9;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ¤ AudioWorklet ê¸°ë°˜ STT</h2>
    <button id="start">â–¶ï¸ ì‹œì‘</button>
    <button id="stop" disabled>â¹ï¸ ì¤‘ì§€</button>
    
    <div id="result-container">
      <div id="transcription"></div>
      <div id="interim" class="interim-text"></div>
    </div>
    
    <pre id="result"></pre>

    <script type="text/javascript">
      let socket;
      let socketReady = false;
      let audioContext;
      let audioStream;
      let workletNode;

      const resultEl = document.getElementById("result");
      const startBtn = document.getElementById("start");
      const stopBtn = document.getElementById("stop");
      const transcriptionEl = document.getElementById("transcription");
      const interimEl = document.getElementById("interim");

      window.onload = () => {
        socket = new WebSocket("ws://localhost:8000/stt/websocket");
        socket.binaryType = "arraybuffer";

        socket.onopen = () => {
          socketReady = true;
          logMessage("ğŸŸ¢ WebSocket ì—°ê²°ë¨.");
        };

        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            logMessage(`ğŸ“¥ ìˆ˜ì‹ : ${JSON.stringify(data)}`);

            switch (data.type) {
              case "interim":
                // ì¤‘ê°„ ê²°ê³¼ - íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
                updateInterimText(data.text);
                break;

              case "final":
                // ìµœì¢… ê²°ê³¼ - ê¸°ì¡´ í…ìŠ¤íŠ¸ì— ê²€ì€ìƒ‰ìœ¼ë¡œ ì¶”ê°€
                addFinalText(data.text);
                break;

              case "system":
                // ì‹œìŠ¤í…œ ë©”ì‹œì§€
                logMessage(`ğŸ”§ ${data.message}`);
                break;

              case "error":
                // ì˜¤ë¥˜ ë©”ì‹œì§€
                logMessage(`âŒ ${data.message}`);
                break;
                
              case "end":
                // ì¢…ë£Œ ë©”ì‹œì§€
                logMessage(`âœ… ìŒì„± ì¸ì‹ ì¢…ë£Œ`);
                clearInterimText();
                break;
            }
          } catch (error) {
            logMessage(`âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error.message}`);
          }
        };

        socket.onerror = (error) => {
          logMessage(`âŒ WebSocket ì˜¤ë¥˜: ${error.message}`);
        };

        socket.onclose = (event) => {
          logMessage(`âœ… WebSocket ì¢…ë£Œë¨ (ì½”ë“œ: ${event.code})`);
        };
      };

      // ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
      function logMessage(message) {
        resultEl.textContent += `\n${message}`;
        resultEl.scrollTop = resultEl.scrollHeight;
      }

      // ì¤‘ê°„ ê²°ê³¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (íšŒìƒ‰ í…ìŠ¤íŠ¸)
      function updateInterimText(text) {
        interimEl.textContent = text;
      }

      // ìµœì¢… ê²°ê³¼ ì¶”ê°€ í•¨ìˆ˜ (ê²€ì€ìƒ‰ í…ìŠ¤íŠ¸)
      function addFinalText(text) {
        if (text && text.trim() !== "") {
          // ì´ì „ í…ìŠ¤íŠ¸ê°€ ìˆê³ , ê³µë°±ìœ¼ë¡œ ëë‚˜ì§€ ì•Šìœ¼ë©´ ê³µë°± ì¶”ê°€
          if (transcriptionEl.textContent && 
              !transcriptionEl.textContent.endsWith(" ")) {
            transcriptionEl.textContent += " ";
          }
          
          transcriptionEl.textContent += text;
        }
        
        // ì¤‘ê°„ ê²°ê³¼ ì´ˆê¸°í™”
        clearInterimText();
      }

      // ì¤‘ê°„ ê²°ê³¼ ì´ˆê¸°í™” í•¨ìˆ˜
      function clearInterimText() {
        interimEl.textContent = "";
      }

      startBtn.onclick = async () => {
        if (!socketReady) {
          logMessage("âŒ WebSocket ì—°ê²°ì´ ì•ˆ ë¨!");
          return;
        }

        try {
          audioContext = new AudioContext({ sampleRate: 16000 });
          await audioContext.audioWorklet.addModule("recorder-processor.js");

          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          const source = audioContext.createMediaStreamSource(audioStream);

          workletNode = new AudioWorkletNode(
            audioContext,
            "recorder-processor"
          );
          source.connect(workletNode);
          workletNode.connect(audioContext.destination);

          workletNode.port.onmessage = (e) => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(e.data);
              // ë¡œê·¸ì—ë§Œ í‘œì‹œí•˜ê³  UIëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
              // logMessage(`ğŸ“¤ ì²­í¬ ì „ì†¡ (${e.data.byteLength} bytes)`);
            }
          };

          socket.send(JSON.stringify({ type: "start", lang: "ko-KR" }));
          logMessage("ğŸ“¤ 'start' ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");

          startBtn.disabled = true;
          stopBtn.disabled = false;
          logMessage("ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ë¨...");
        } catch (err) {
          logMessage(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
          console.error("ì „ì²´ ì˜¤ë¥˜:", err);
        }
      };

      stopBtn.onclick = () => {
        if (audioContext) audioContext.close();
        if (audioStream)
          audioStream.getTracks().forEach((track) => track.stop());
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "end" }));
          logMessage("ğŸ“¤ 'end' ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
        logMessage("â¹ï¸ ë…¹ìŒ ì¤‘ì§€ ì™„ë£Œ.");
        
        // ì¤‘ê°„ ê²°ê³¼ ì´ˆê¸°í™”
        clearInterimText();
      };
    </script>
  </body>
</html>