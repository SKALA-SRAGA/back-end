<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>STT WebSocket í…ŒìŠ¤íŠ¸</title>
</head>
<body>
  <h2>ğŸ¤ ë§ˆì´í¬ STT ë…¹ìŒ ë° ì „ì†¡</h2>
  <button id="start">â–¶ï¸ ë…¹ìŒ ì‹œì‘</button>
  <button id="stop" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€ ë° ì „ì†¡</button>
  <pre id="result"></pre>

  <script>
    let socket;
    let mediaRecorder;
    let audioStream;
    let recordedChunks = [];

    const resultEl = document.getElementById("result");
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");

    // WebSocket ì—°ê²°
    const connectWebSocket = () => {
      socket = new WebSocket("ws://localhost:8000/stt/websocket/");
      socket.binaryType = "arraybuffer";

      socket.onopen = () => {
        resultEl.textContent = "ğŸ”´ WebSocket ì—°ê²°ë¨...\n";
      };

      socket.onmessage = (event) => {
        resultEl.textContent += `\nğŸ“ ì„œë²„ ì‘ë‹µ: ${event.data}`;
      };

      socket.onerror = (error) => {
        console.error("WebSocket ì˜¤ë¥˜:", error);
        resultEl.textContent += `\nâŒ WebSocket ì˜¤ë¥˜: ${error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`;
      };

      socket.onclose = (event) => {
        resultEl.textContent += `\nâœ… WebSocket ì—°ê²° ì¢…ë£Œë¨ (ì½”ë“œ: ${event.code})`;
      };
    };

    // ë…¹ìŒ ì‹œì‘
    startBtn.onclick = async () => {
      try {
        // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° MediaStream ì—´ê¸°
        audioStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            sampleRate: 16000,
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true,
          },
        });

        // MediaRecorder ì„¤ì •
        mediaRecorder = new MediaRecorder(audioStream, {
          mimeType: "audio/webm;codecs=opus",
          audioBitsPerSecond: 16000,
        });

        recordedChunks = []; // ë…¹ìŒ ë°ì´í„° ì´ˆê¸°í™”

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            recordedChunks.push(e.data); // ë…¹ìŒëœ ì²­í¬ ì €ì¥
          }
        };

        mediaRecorder.onstop = () => {
          // ë…¹ìŒ ì¤‘ì§€ í›„ WebSocketìœ¼ë¡œ ë°ì´í„° ì „ì†¡
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const reader = new FileReader();
          reader.onload = () => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(reader.result); // WebSocketìœ¼ë¡œ ë°ì´í„° ì „ì†¡
              resultEl.textContent += "\nğŸ“¤ ë…¹ìŒ ë°ì´í„° ì „ì†¡ ì™„ë£Œ!";
            } else {
              resultEl.textContent += "\nâŒ WebSocket ì—°ê²°ì´ ë‹«í˜€ ìˆìŒ.";
            }
          };
          reader.readAsArrayBuffer(blob);
        };

        mediaRecorder.start(); // ë…¹ìŒ ì‹œì‘
        resultEl.textContent += "\nğŸ™ï¸ ë…¹ìŒ ì‹œì‘ë¨...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (error) {
        console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
        resultEl.textContent = `ì˜¤ë¥˜: ${error.message}`;
      }
    };

    // ë…¹ìŒ ì¤‘ì§€
    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop(); // ë…¹ìŒ ì¤‘ì§€
        resultEl.textContent += "\nâ¹ï¸ ë…¹ìŒ ì¤‘ì§€ë¨.";
      }

      if (audioStream) {
        audioStream.getTracks().forEach((track) => track.stop()); // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // WebSocket ì—°ê²° ì´ˆê¸°í™”
    connectWebSocket();
  </script>
</body>
</html>